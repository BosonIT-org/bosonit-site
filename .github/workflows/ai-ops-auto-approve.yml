name: AI Ops Auto Approval

on:
  pull_request_target:
    branches:
      - main
      - staging
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - ready_for_review

permissions:
  contents: read
  checks: read
  pull-requests: write

jobs:
  auto-approve:
    name: ai-ops auto-approve
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - name: Evaluate gate and approve if eligible
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name);
            const gated = labels.includes("human-approval-required");
            if (!gated) {
              core.info("No human-approval-required label; skipping.");
              return;
            }

            if (!pr.head.ref.startsWith("codex/")) {
              core.info(`Head ref ${pr.head.ref} is not a codex/* branch; skipping auto-approval.`);
              return;
            }

            const requiredChecks = [
              "security / gitleaks",
              "policy / habitat-guardrails",
              "ci / test"
            ];

            const checks = await github.paginate(
              github.rest.checks.listForRef,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
                per_page: 100
              }
            );

            const latest = new Map();
            for (const run of checks) {
              if (!latest.has(run.name)) {
                latest.set(run.name, run);
              }
            }

            const missing = [];
            const failing = [];
            for (const name of requiredChecks) {
              const run = latest.get(name);
              if (!run) {
                missing.push(name);
                continue;
              }
              if (run.status !== "completed" || run.conclusion !== "success") {
                failing.push(`${name} (${run.status}/${run.conclusion})`);
              }
            }

            if (missing.length || failing.length) {
              core.info(`Required checks not ready. missing=${missing.join(",")} failing=${failing.join(",")}`);
              return;
            }

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100
              }
            );

            const alreadyApproved = reviews.some(
              r => r.user && r.user.login === "github-actions[bot]" && r.state === "APPROVED"
            );

            if (alreadyApproved) {
              core.info("github-actions[bot] already approved this PR.");
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: "APPROVE",
              body: "Delegated ai-ops approval: required checks passed and approval gate conditions satisfied."
            });

            core.info("Auto-approval submitted by github-actions[bot].");
