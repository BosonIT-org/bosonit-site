name: PR Readiness Checks

on:
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:

permissions:
  contents: read

jobs:
  security-gitleaks:
    name: security / gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks (OSS)
        run: |
          set -euo pipefail
          VERSION="8.24.2"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" \
            -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C /tmp
          sudo install /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version
      - name: Run gitleaks
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          gitleaks git --redact --log-opts="origin/main..HEAD"
      - name: Smoke-check high-risk key patterns in PR diff
        run: |
          set -euo pipefail
          if git diff origin/main...HEAD | grep -nE 'BEGIN PRIVATE KEY|OPENAI_API_KEY|ANTHROPIC_API_KEY|GEMINI_API_KEY|aws_secret_access_key'; then
            echo "SECRET_SMOKE_MATCH"
            exit 41
          fi

  policy-habitat-guardrails:
    name: policy / habitat-guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate CIO routing policy contract
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          required = Path("ops/governance/model_role_registry.json")
          if not required.exists():
              raise SystemExit("missing ops/governance/model_role_registry.json")

          data = json.loads(required.read_text())
          required_keys = ["provider_order", "fallback_policy", "default_on_unknown", "human_approval_gate"]
          missing = [k for k in required_keys if k not in data]
          if missing:
              raise SystemExit(f"missing policy keys: {missing}")

          fallback = data.get("fallback_policy", {})
          for key in ("allowed_triggers", "denied_triggers", "fallback_targets"):
              if key not in fallback:
                  raise SystemExit(f"missing fallback policy key: {key}")

          print("policy validation passed")
          PY

  ci-test:
    name: ci / test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
