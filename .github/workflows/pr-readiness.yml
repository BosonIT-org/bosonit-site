name: PR Readiness Checks

on:
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:

permissions:
  contents: read

jobs:
  security-gitleaks:
    name: security / gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  policy-habitat-guardrails:
    name: policy / habitat-guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate CIO routing policy contract
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          required = Path("ops/governance/model_role_registry.json")
          if not required.exists():
              raise SystemExit("missing ops/governance/model_role_registry.json")

          data = json.loads(required.read_text())
          required_keys = ["provider_order", "fallback_policy", "default_on_unknown", "human_approval_gate"]
          missing = [k for k in required_keys if k not in data]
          if missing:
              raise SystemExit(f"missing policy keys: {missing}")

          fallback = data.get("fallback_policy", {})
          for key in ("allowed_triggers", "denied_triggers", "fallback_targets"):
              if key not in fallback:
                  raise SystemExit(f"missing fallback policy key: {key}")

          print("policy validation passed")
          PY

  ci-test:
    name: ci / test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
