name: Habitat Warden

on:
  pull_request:
    branches:
      - main
      - staging
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

jobs:
  habitat-warden:
    name: habitat-warden
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build changed-file inventory
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="${{ github.base_ref || 'main' }}"
          HEAD_SHA="${{ github.sha }}"
          git fetch origin "$BASE_REF" --depth=1
          git diff --name-only "origin/${BASE_REF}...${HEAD_SHA}" > /tmp/changed-files.txt

      - name: Generate advisory habitat assessment
        id: assess
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          import re
          from pathlib import Path

          changed = [
              line.strip()
              for line in Path('/tmp/changed-files.txt').read_text(encoding='utf-8').splitlines()
              if line.strip()
          ]
          policy = json.loads(Path('.github/codex/habitat-policy.json').read_text(encoding='utf-8'))
          regexes = [re.compile(p) for p in policy.get('critical_habitat_regex', [])]
          critical = any(any(r.search(path) for r in regexes) for path in changed)

          assessment = {
              "conservation_status_change": "NEUTRAL",
              "critical_habitat_interference": critical,
              "mitigation_plan_verified": (not critical),
              "invasive_pattern_detection": [],
              "regulatory_verdict": "REQUIRE_APPROVAL" if critical else "APPROVE"
          }

          Path('assessment.json').write_text(json.dumps(assessment, indent=2), encoding='utf-8')
          PY

          verdict="$(python3 - <<'PY'
          import json
          print(json.load(open('assessment.json', 'r', encoding='utf-8'))['regulatory_verdict'])
          PY
          )"
          requires_approval=false
          if [ "$verdict" = "REQUIRE_APPROVAL" ] || [ "$verdict" = "DENY" ]; then
            requires_approval=true
          fi

          echo "regulatory_verdict=$verdict" >> "$GITHUB_OUTPUT"
          echo "requires_approval=$requires_approval" >> "$GITHUB_OUTPUT"
          echo "assessment_json_path=assessment.json" >> "$GITHUB_OUTPUT"

      - name: Upload assessment artifact
        uses: actions/upload-artifact@v4
        with:
          name: habitat-assessment
          path: assessment.json
          if-no-files-found: error

      - name: Evaluate delegated approval gate
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = (pr.labels || []).map(l => l.name);
            const hasGateLabel = labels.includes("human-approval-required");

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 100
              }
            );

            const latestByUser = new Map();
            for (const review of reviews) {
              if (review.user && review.user.login) {
                latestByUser.set(review.user.login, review.state);
              }
            }

            const approvedByBot = latestByUser.get("github-actions[bot]") === "APPROVED";
            core.setOutput("has_gate_label", String(hasGateLabel));
            core.setOutput("approved_by_bot", String(approvedByBot));
            core.setOutput("approval_gate_satisfied", String(hasGateLabel && approvedByBot));

      - name: Write step summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Habitat Warden"
            echo "- Verdict: \`${{ steps.assess.outputs.regulatory_verdict }}\`"
            echo "- Requires approval: \`${{ steps.assess.outputs.requires_approval }}\`"
            echo "- Gate label present: \`${{ steps.gate.outputs.has_gate_label }}\`"
            echo "- Approved by delegated bot: \`${{ steps.gate.outputs.approved_by_bot }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce policy mode with delegated approval support
        shell: bash
        run: |
          set -euo pipefail
          MODE="$(python3 - <<'PY'
          import json
          print(json.load(open('.github/codex/habitat-policy.json', 'r', encoding='utf-8')).get('mode', 'advisory'))
          PY
          )"
          VERDICT="${{ steps.assess.outputs.regulatory_verdict }}"
          GATE_OK="${{ steps.gate.outputs.approval_gate_satisfied }}"

          if [ "$MODE" != "enforce" ]; then
            echo "Advisory mode active."
            exit 0
          fi

          if [ "$VERDICT" = "APPROVE" ]; then
            echo "Verdict approve."
            exit 0
          fi

          if [ "$VERDICT" = "DENY" ]; then
            echo "Enforcement active: verdict=DENY"
            exit 1
          fi

          if [ "$VERDICT" = "REQUIRE_APPROVAL" ] && [ "$GATE_OK" = "true" ]; then
            echo "Require-approval verdict satisfied by delegated ai-ops approval gate."
            exit 0
          fi

          echo "Enforcement active: verdict=$VERDICT gate_ok=$GATE_OK"
          exit 1
